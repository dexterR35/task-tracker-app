// Prisma Schema for Task Tracker Application
// Scalable and Maintainable Database Design
// Supports: Users, Authentication, Tasks, Reporters, Deliverables, Real-time features

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// AUTHENTICATION & USER MANAGEMENT
// ============================================================================

// User Model - Core user table for authentication and profile
model User {
  id        String   @id @default(uuid())
  email     String   @unique
  password  String   // Bcrypt hashed password
  
  // Profile Information
  name        String?
  displayName String?
  firstName   String?
  lastName    String?
  photoURL    String?
  phoneNumber String?
  
  // Role & Permissions (RBAC - Role Based Access Control)
  role        UserRole @default(USER)
  permissions String[] // Additional granular permissions
  
  // Organization/Department
  department  String?
  position    String?
  
  // Account Status
  isActive    Boolean  @default(true)
  isVerified  Boolean  @default(false)
  lastLoginAt DateTime?
  
  // Security
  passwordChangedAt DateTime?
  failedLoginAttempts Int @default(0)
  lockedUntil DateTime?
  
  // Timestamps (Audit Trail)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  deletedAt DateTime? // Soft delete
  
  // Relations
  sessions         Session[]         @relation("UserSessions")
  tasks            Task[]            @relation("UserTasks")
  createdTasks     Task[]            @relation("CreatedByUser")
  createdReporters Reporter[]        @relation("CreatedReporters")
  updatedReporters Reporter[]        @relation("UpdatedReporters")
  createdBoards    Board[]           @relation("CreatedBoards")
  activityLogs     ActivityLog[]     @relation("UserActivityLogs")
  
  @@index([email])
  @@index([role])
  @@index([isActive])
  @@index([createdAt])
  @@map("users")
}

// User Role Enum - Define all possible roles
enum UserRole {
  USER      // Regular user - can create and manage own tasks
  ADMIN     // Admin user - full access to all features
  MANAGER   // Manager - can view team tasks
  VIEWER    // Read-only access
}

// Session Model - Track user sessions for JWT token management
model Session {
  id           String   @id @default(uuid())
  userId       String   // Reference to User.id
  
  // Token Information
  accessToken  String   @unique
  refreshToken String?  @unique
  tokenType    String   @default("Bearer")
  
  // Session Metadata
  ipAddress    String?
  userAgent    String?
  device       String?
  location     String?
  
  // Session Status
  isValid      Boolean  @default(true)
  expiresAt    DateTime
  lastActivityAt DateTime @default(now())
  
  // Timestamps
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  
  // Relations
  user         User     @relation("UserSessions", fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId])
  @@index([accessToken])
  @@index([refreshToken])
  @@index([expiresAt])
  @@index([isValid])
  @@map("sessions")
}

// ============================================================================
// REPORTERS MANAGEMENT
// ============================================================================

// Reporter Model - External reporters/stakeholders for tasks
model Reporter {
  id          String   @id @default(uuid())
  
  // Reporter Information
  name        String
  email       String   @unique
  phoneNumber String?
  department  String?
  company     String?
  position    String?
  
  // Status
  isActive    Boolean  @default(true)
  
  // Audit Trail
  createdById   String? // User.id
  createdByName String?
  updatedById   String? // User.id
  updatedByName String?
  
  // Timestamps
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  deletedAt     DateTime? // Soft delete
  
  // Relations
  tasks      Task[]  @relation("ReporterTasks")
  creator    User?   @relation("CreatedReporters", fields: [createdById], references: [id], onDelete: SetNull)
  updater    User?   @relation("UpdatedReporters", fields: [updatedById], references: [id], onDelete: SetNull)
  
  @@index([email])
  @@index([isActive])
  @@index([createdAt])
  @@map("reporters")
}

// ============================================================================
// DELIVERABLES MANAGEMENT
// ============================================================================

// Deliverable Model - Types of deliverables for tasks
model Deliverable {
  id          String   @id @default(uuid())
  name        String   @unique
  
  // Deliverable Details
  description String?
  category    String?
  estimatedTime Float? // Default estimated time in hours
  complexity  Int?    // Default complexity score (1-10)
  
  // Status
  isActive    Boolean  @default(true)
  
  // Audit Trail
  createdById   String? // User.id
  createdByName String?
  updatedById   String? // User.id
  updatedByName String?
  
  // Timestamps
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  deletedAt     DateTime? // Soft delete
  
  // Relations (Many-to-Many with Task)
  tasks TaskDeliverable[]
  
  @@index([name])
  @@index([category])
  @@index([isActive])
  @@map("deliverables")
}

// ============================================================================
// BOARDS (MONTH) MANAGEMENT
// ============================================================================

// Board/Month Model - Represents monthly task boards
model Board {
  id        String   @id @default(uuid())
  boardId   String   @unique // Unique board identifier
  monthId   String   @unique // e.g., "2024-09" (YYYY-MM)
  
  // Board Details
  year       String   // e.g., "2024"
  month      String   // e.g., "09" or "January"
  department String   @default("design")
  title      String?  // Optional board title
  
  // Status
  isActive   Boolean  @default(true)
  isClosed   Boolean  @default(false)
  
  // Audit Trail
  createdBy     String? // User.id
  createdByName String?
  
  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // Relations
  tasks     Task[]
  creator   User?    @relation("CreatedBoards", fields: [createdBy], references: [id], onDelete: SetNull)
  
  @@index([monthId])
  @@index([year])
  @@index([department])
  @@index([isActive])
  @@map("boards")
}

// ============================================================================
// TASKS MANAGEMENT (CORE)
// ============================================================================

// Task Model - Main task/work item data
model Task {
  id       String   @id @default(uuid())
  
  // Foreign Keys
  userId   String   // User.id
  boardId  String   // Board.boardId
  monthId  String   // e.g., "2024-09"
  
  // Task Basic Information
  name            String
  gimodear        String? // Task identifier/code
  description     String?  @db.Text
  taskType        String?
  
  // Categorization
  products        String? // marketing, acquisition, product
  departments     String[] // Array of departments involved
  
  // Reporter/Stakeholder
  reporterId      String? // Reporter.id
  reporterName    String?
  
  // Deliverables (for quick filtering without joins)
  deliverableNames String[]
  
  // AI Usage Tracking
  hasAiUsed       Boolean @default(false)
  aiUsed          Json? // Detailed AI usage data: [{ aiModels: [], description: '' }]
  
  // Task Properties/Flags
  isVip           Boolean @default(false)
  reworked        Boolean @default(false)
  useShutterstock Boolean @default(false)
  isCompleted     Boolean @default(false) // Simple completed flag
  
  // Time & Complexity Metrics
  complexity      Int?     // 1-10 complexity score
  estimatedTime   Float?   // Estimated hours
  actualTime      Float?   // Actual hours spent
  startDate       DateTime?
  dueDate         DateTime?
  completedAt     DateTime?
  
  // Additional Metadata (flexible for future extensions)
  metadata        Json?
  tags            String[] // Tags for categorization
  
  // Audit Trail
  createdById     String? // User.id
  createdByName   String?
  
  // Timestamps
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  deletedAt       DateTime? // Soft delete
  
  // Relations
  user            User               @relation("UserTasks", fields: [userId], references: [id], onDelete: Cascade)
  createdBy       User?              @relation("CreatedByUser", fields: [createdById], references: [id], onDelete: SetNull)
  reporter        Reporter?          @relation("ReporterTasks", fields: [reporterId], references: [id], onDelete: SetNull)
  board           Board              @relation(fields: [boardId], references: [boardId], onDelete: Cascade)
  deliverables    TaskDeliverable[]
  activityLogs    ActivityLog[]      @relation("TaskActivityLogs")
  
  @@index([userId])
  @@index([monthId])
  @@index([boardId])
  @@index([reporterId])
  @@index([products])
  @@index([hasAiUsed])
  @@index([isVip])
  @@index([isCompleted])
  @@index([createdAt])
  @@index([dueDate])
  @@unique([userId, gimodear, name]) // Prevent duplicate tasks per user
  @@map("tasks")
}

// ============================================================================
// JUNCTION TABLES (Many-to-Many Relationships)
// ============================================================================

// Task-Deliverable Junction Table
model TaskDeliverable {
  id            String      @id @default(uuid())
  taskId        String
  deliverableId String
  
  // Additional metadata for this specific relationship
  quantity      Int?        @default(1)
  notes         String?
  
  // Relations
  task        Task        @relation(fields: [taskId], references: [id], onDelete: Cascade)
  deliverable Deliverable @relation(fields: [deliverableId], references: [id], onDelete: Cascade)
  
  // Timestamps
  createdAt   DateTime    @default(now())
  
  @@unique([taskId, deliverableId])
  @@index([taskId])
  @@index([deliverableId])
  @@map("task_deliverables")
}

// ============================================================================
// ACTIVITY LOGS (Audit Trail)
// ============================================================================

// Activity Log Model - Track all important actions for audit trail
model ActivityLog {
  id          String   @id @default(uuid())
  
  // Actor Information
  userId      String?  // Who performed the action
  userName    String?
  
  // Action Details
  action      String   // e.g., "CREATE", "UPDATE", "DELETE", "LOGIN", "LOGOUT"
  entity      String   // e.g., "TASK", "USER", "REPORTER", "DELIVERABLE"
  entityId    String?  // ID of the affected entity
  
  // Task-specific logging (optional)
  taskId      String?
  
  // Change Details
  changes     Json?    // Before/after values for updates
  metadata    Json?    // Additional context
  
  // Request Information
  ipAddress   String?
  userAgent   String?
  
  // Timestamps
  createdAt   DateTime @default(now())
  
  // Relations
  user        User?    @relation("UserActivityLogs", fields: [userId], references: [id], onDelete: SetNull)
  task        Task?    @relation("TaskActivityLogs", fields: [taskId], references: [id], onDelete: SetNull)
  
  @@index([userId])
  @@index([action])
  @@index([entity])
  @@index([entityId])
  @@index([taskId])
  @@index([createdAt])
  @@map("activity_logs")
}
